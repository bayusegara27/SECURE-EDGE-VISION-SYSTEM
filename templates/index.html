<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECURE EDGE | Live View</title>
    <link rel="stylesheet" href="/static/css/shared.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-logo">
            <i data-lucide="shield" size="20" color="white"></i>
        </div>
        <div class="sidebar-nav">
            <a href="/" class="nav-item active" title="Live View">
                <i data-lucide="monitor" size="20"></i>
            </a>
            <a href="/gallery" class="nav-item" title="Recordings">
                <i data-lucide="folder" size="20"></i>
            </a>
            <a href="/analytics" class="nav-item" title="Analytics">
                <i data-lucide="bar-chart-2" size="20"></i>
            </a>
            <a href="/decrypt" class="nav-item" title="Decrypt Evidence">
                <i data-lucide="lock" size="20"></i>
            </a>
        </div>
        <div class="sidebar-bottom">
            <div class="nav-item" title="Settings">
                <i data-lucide="settings" size="20"></i>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-title">
                <i data-lucide="video" size="18"></i>
                Live View
                <span id="timeDisplay" style="margin-left: 20px; color: var(--text-dim); font-weight: normal;"></span>
            </div>
            <div class="header-status">
                <span class="status-dot"></span>
                <span id="activeCameraCount">0 Active</span>
                <span>|</span>
                <span id="storageStatus">--</span>
            </div>
        </header>

        <!-- Camera Grid Area -->
        <div class="content-area">
            <div class="camera-grid grid-4" id="cameraGrid">
                <!-- Tiles generated by JS -->
            </div>
        </div>

        <!-- Footer Toolbar -->
        <footer class="footer-toolbar">
            <button class="toolbar-btn" onclick="setGrid(1)" id="grid-btn-1">
                <i data-lucide="square" size="18"></i>
                1x1
            </button>
            <button class="toolbar-btn active" onclick="setGrid(4)" id="grid-btn-4">
                <i data-lucide="layout-grid" size="18"></i>
                2x2
            </button>
            <button class="toolbar-btn" onclick="setGrid(9)" id="grid-btn-9">
                <i data-lucide="grid" size="18"></i>
                3x3
            </button>
            <button class="toolbar-btn" onclick="setGrid(16)" id="grid-btn-16">
                <i data-lucide="layout" size="18"></i>
                4x4
            </button>
            <button class="toolbar-btn" onclick="setGrid(64)" id="grid-btn-64">
                <i data-lucide="layers" size="18"></i>
                8x8
            </button>
            <div class="toolbar-divider"></div>
            <button class="toolbar-btn" onclick="location.reload()">
                <i data-lucide="refresh-cw" size="16"></i>
                Refresh
            </button>
        </footer>
    </main>

    <script>
        let availableCameras = {{ cameras | tojson }};
        let currentGridSize = 4;
        let selectedTile = null;
        let gridStartIdx = 0; // Starting camera index for current grid view
        let zoomedTileIdx = null;

        // Init icons
        lucide.createIcons();

        // Update time
        function updateTime() {
            const now = new Date();
            const display = document.getElementById('timeDisplay');
            if (display) {
                display.textContent = now.toLocaleDateString('id-ID') + '  ' + now.toLocaleTimeString('id-ID');
            }
        }
        updateTime();
        setInterval(updateTime, 1000);

        // Grid Management
        function setGrid(size) {
            currentGridSize = size;
            gridStartIdx = 0; // Reset to first cam when switching grid types
            const grid = document.getElementById('cameraGrid');
            
            grid.classList.remove('grid-1', 'grid-4', 'grid-9', 'grid-16', 'grid-64');
            grid.classList.add('grid-' + size);
            
            document.querySelectorAll('.toolbar-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.getElementById('grid-btn-' + size);
            if (btn) btn.classList.add('active');
            
            renderTiles(size);
        }

        function renderTiles(size) {
            const grid = document.getElementById('cameraGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < size; i++) {
                const camIdxInList = gridStartIdx + i;
                const isCamera = camIdxInList < availableCameras.length;
                const camIdx = isCamera ? availableCameras[camIdxInList] : null;
                
                const tile = document.createElement('div');
                tile.className = 'camera-tile' + (!isCamera ? ' empty' : '');
                tile.id = 'tile-' + i;
                tile.onclick = () => selectTile(i);
                tile.ondblclick = () => toggleZoom(i);
                
                if (isCamera) {
                    tile.innerHTML = `
                        <img id="stream-${camIdx}" src="/stream/${camIdx}" 
                             onload="handleStreamLoad(${camIdx})" 
                             onerror="handleStreamError(${camIdx})">
                        <div class="camera-offline" style="display: none;">
                            <i data-lucide="alert-triangle" size="48" class="offline-icon"></i>
                            <div class="offline-text">
                                Connection failed, <span class="relink" onclick="location.reload()">Reconnection</span>
                            </div>
                        </div>
                        <div class="nav-overlay">
                            <button class="nav-btn prev" onclick="navigate(-1); event.stopPropagation();">
                                <i data-lucide="chevron-left" size="24"></i>
                            </button>
                            <button class="nav-btn next" onclick="navigate(1); event.stopPropagation();">
                                <i data-lucide="chevron-right" size="24"></i>
                            </button>
                        </div>
                        <div class="camera-overlay">
                            <div class="camera-id">CAM ${camIdx}</div>
                            <span class="rec-badge">REC</span>
                        </div>
                    `;
                } else {
                    tile.innerHTML = `<i data-lucide="plus" size="24" color="rgba(255,255,255,0.1)"></i>`;
                }
                
                grid.appendChild(tile);
            }
            lucide.createIcons();
            updateStatus();
        }

        function selectTile(index) {
            document.querySelectorAll('.camera-tile').forEach(t => t.classList.remove('selected'));
            const tile = document.getElementById('tile-' + index);
            if (tile) tile.classList.add('selected');
            selectedTile = index;
        }

        // Zoom & Navigation
        function toggleZoom(index) {
            const tile = document.getElementById('tile-' + index);
            if (!tile || tile.classList.contains('empty')) return;

            if (zoomedTileIdx === index) {
                tile.classList.remove('zoomed');
                zoomedTileIdx = null;
            } else {
                if (zoomedTileIdx !== null) {
                    const prev = document.getElementById('tile-' + zoomedTileIdx);
                    if (prev) prev.classList.remove('zoomed');
                }
                tile.classList.add('zoomed');
                zoomedTileIdx = index;
            }
        }

        function navigate(dir) {
            if (zoomedTileIdx !== null) {
                // Determine the global index of the next camera
                const currentCamIdxInList = gridStartIdx + zoomedTileIdx;
                const nextCamIdxInList = (currentCamIdxInList + dir + availableCameras.length) % availableCameras.length;
                
                // Check if the next camera is already visible in the current grid view
                if (nextCamIdxInList >= gridStartIdx && nextCamIdxInList < gridStartIdx + currentGridSize) {
                    // It's in the current view! Just move the zoom focus.
                    const newTileIdx = nextCamIdxInList - gridStartIdx;
                    toggleZoom(zoomedTileIdx); // Exit current
                    toggleZoom(newTileIdx);    // Enter next
                } else {
                    // It's outside the current view. Shift the grid "page" and zoom.
                    // Align to multiples of gridSize to keep the view stable and organized.
                    gridStartIdx = Math.floor(nextCamIdxInList / currentGridSize) * currentGridSize;
                    renderTiles(currentGridSize);
                    toggleZoom(nextCamIdxInList % currentGridSize);
                }
            } else if (currentGridSize === 1) {
                // In 1x1 mode, just cycle through all cameras
                gridStartIdx = (gridStartIdx + dir + availableCameras.length) % availableCameras.length;
                renderTiles(1);
            }
        }

        // Keyboard Support
        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight' || e.key === 'ArrowDown') navigate(1);
            if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') navigate(-1);
            if (e.key === 'Escape' && zoomedTileIdx !== null) toggleZoom(zoomedTileIdx);
        });

        // Stream Status
        function handleStreamLoad(idx) {
            const img = document.getElementById('stream-' + idx);
            if (!img) return;
            img.style.display = 'block';
            const offline = img.parentElement.querySelector('.camera-offline');
            if (offline) offline.style.display = 'none';
        }

        function handleStreamError(idx) {
            const img = document.getElementById('stream-' + idx);
            if (!img) return;
            img.style.display = 'none';
            const offline = img.parentElement.querySelector('.camera-offline');
            if (offline && offline.style.display !== 'flex') {
                offline.style.display = 'flex';
                lucide.createIcons(); // Ensure icon is rendered
            }
        }

        // Fetch overall status
        async function updateStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                
                if (data.storage) {
                    const used = data.storage.used_gb || 0;
                    const storage = document.getElementById('storageStatus');
                    if (storage) storage.textContent = `Disk: ${used.toFixed(1)}GB used`;
                }
                
                const activeCount = data.cameras ? data.cameras.filter(c => c.state === 'online').length : 0;
                const countDisplay = document.getElementById('activeCameraCount');
                if (countDisplay) countDisplay.textContent = `${activeCount} Active`;

                // Update REC badges and Offline overlays based on status
                if (data.cameras) {
                    data.cameras.forEach((cam) => {
                        const img = document.getElementById(`stream-${cam.id}`);
                        if (img) {
                            const tile = img.closest('.camera-tile');
                            if (tile) {
                                const offline = tile.querySelector('.camera-offline');
                                if (cam.state === 'online') {
                                    tile.classList.add('online');
                                    tile.classList.remove('offline');
                                    if (offline) offline.style.display = 'none';
                                    if (img.style.display === 'none') img.style.display = 'block';
                                } else {
                                    tile.classList.remove('online');
                                    tile.classList.add('offline');
                                    if (offline && (offline.style.display !== 'flex' || !offline.querySelector('svg'))) {
                                        offline.style.display = 'flex';
                                        lucide.createIcons();
                                    }
                                    img.style.display = 'none';
                                }
                            }
                        }
                    });
                }
                
            } catch (e) {}
        }

        // Initial render
        setGrid(4);
        setInterval(updateStatus, 5000);
        updateStatus();
    </script>
</body>
</html>

